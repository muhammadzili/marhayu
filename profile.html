<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Marhayu</title>
    <link rel="shortcut icon" href="/assets/marhayu-white.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        html, body { 
            overflow: hidden; 
            height: 100%;
        }
        body { font-family: 'Inter', sans-serif; }
        .font-lora { font-family: 'Lora', serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .modal-content::-webkit-scrollbar, .sidebar-nav::-webkit-scrollbar { display: none; }
        .modal-content, .sidebar-nav { -ms-overflow-style: none; scrollbar-width: none; }
        .icon-btn { transition: color 0.2s ease-in-out; }
        .comment-pinned .bg-gray-100 { background-color: #f0f9ff !important; }
        .mention-popup { position: absolute; z-index: 100; background-color: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); max-height: 200px; overflow-y: auto; }
        .mention-item { display: flex; align-items: center; padding: 0.5rem; cursor: pointer; }
        .mention-item:hover { background-color: #f3f4f6; }
        .notification-badge { position: absolute; top: 0.5rem; right: 0.5rem; width: 0.75rem; height: 0.75rem; border-radius: 9999px; background-color: #ef4444; border: 2px solid white; }
        .custom-video-player { position: relative; background-color: #000; border-radius: 1rem; overflow: hidden; line-height: 0; }
        .custom-video-player video { display: block; margin: 0 auto; width: auto; height: auto; max-width: 100%; max-height: 560px; border-radius: 1rem; }
        .video-controls-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease; cursor: pointer; }
        .custom-video-player:hover .video-controls-overlay { opacity: 1; }
        .video-controls-overlay .play-pause-btn { background: rgba(0,0,0,0.5); border: 2px solid white; color: white; width: 4rem; height: 4rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        .volume-btn { position: absolute; bottom: 0.75rem; right: 0.75rem; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; text-shadow: 0 0 5px black; z-index: 10; }
        .video-progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background-color: rgba(255,255,255,0.3); cursor: pointer; }
        .video-progress-filled { width: 0%; height: 100%; background-color: #fff; transition: width 0.1s linear; }
        
        #global-reaction-popover {
            position: fixed;
            background-color: white;
            border-radius: 9999px;
            padding: 0.25rem 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            gap: 0.5rem;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.9) translateY(10px);
            transition: opacity 0.15s ease-out, transform 0.15s ease-out, visibility 0s linear 0.2s;
        }
        #global-reaction-popover.visible {
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateY(0);
            transition-delay: 0s;
        }
        .reaction-emoji { font-size: 1.5rem; cursor: pointer; transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .reaction-emoji:hover { transform: scale(1.4); }
        .reaction-summary { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
        .reaction-pill { display: flex; align-items: center; gap: 0.25rem; background-color: #eef2ff; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .user-reacted { background-color: #c7d2fe; border: 1px solid #818cf8; }

        #comment-modal, #confirm-modal, #edit-profile-modal { transition: opacity 0.25s ease, visibility 0.25s ease; opacity: 0; visibility: hidden; }
        #comment-modal.is-visible, #confirm-modal.is-visible, #edit-profile-modal.is-visible { opacity: 1; visibility: visible; }
        #comment-modal .modal-box, #confirm-modal .modal-box, #edit-profile-modal .modal-box { transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0.95) translateY(15px); }
        #comment-modal.is-visible .modal-box, #confirm-modal.is-visible .modal-box, #edit-profile-modal.is-visible .modal-box { transform: scale(1) translateY(0); }

        .skeleton { background-color: #e5e7eb; border-radius: 0.5rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }

        .interactive-btn { transition: transform 0.1s ease-out, background-color 0.2s ease; }
        .interactive-btn:active { transform: scale(0.95); }
        .post-enter-animation { animation: fadeInSlideUp 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .poll-option { position: relative; border: 1px solid #d1d5db; border-radius: 0.75rem; padding: 0.75rem; cursor: pointer; overflow: hidden; transition: border-color 0.2s, background-color 0.2s; }
        .poll-option:hover { border-color: #6366f1; }
        .poll-option.user-voted { border-color: #4f46e5; background-color: #e0e7ff; font-weight: 500; }
        .poll-progress { position: absolute; top: 0; left: 0; height: 100%; background-color: #c7d2fe; width: 0%; z-index: 1; transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1); }
        .poll-option-content { position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; }
        .poll-option-percent { font-weight: 600; }
        .copied-post-label { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.125rem 0.5rem; background-color: #f3f4f6; border-radius: 9999px; font-size: 0.75rem; color: #4b5563; margin-top: 0.5rem; }
        
        #toast-notification { position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%) translateY(100px); background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(4px); color: white; padding: 0.75rem 1.5rem; border-radius: 9999px; z-index: 100; opacity: 0; visibility: hidden; transition: transform 0.3s ease, opacity 0.3s ease, visibility 0s linear 0.3s; }
        #toast-notification.show { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; transition-delay: 0s; }
    </style>
</head>
<body class="bg-white text-black">

    <div class="container mx-auto max-w-4xl flex flex-row md:gap-8 h-full">
        <aside class="hidden md:block w-[280px] flex-shrink-0 pt-8 pr-4">
            <a href="/index.html"><img src="https://mage.mzili.my.id/uploads/img_68c50e457ef002.30239660.png" alt="Logo Marhayu" class="h-10 mb-8"></a>
            <nav class="space-y-1 text-lg sidebar-nav">
                <a href="/index.html" class="flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 transition-colors"><i class="bi bi-house-door text-2xl"></i><span>Beranda</span></a>
                <a href="/search.html" class="flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 transition-colors"><i class="bi bi-search text-2xl"></i><span>Pencarian</span></a>
                <a href="/notifications.html" class="relative flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="bi bi-bell text-2xl"></i><span>Notifikasi</span>
                    <span id="notification-badge-sidebar" class="hidden notification-badge"></span>
                </a>
                <a href="#" id="profile-link-sidebar" class="flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 transition-colors font-bold text-black"><i class="bi bi-person-fill text-2xl"></i><span>Profil</span></a>
            </nav>
            <button id="logout-button" class="mt-8 w-full bg-black text-white py-2 rounded-full font-semibold hover:bg-gray-800 transition-colors interactive-btn">Keluar</button>
        </aside>

        <main class="w-full min-w-0 md:border-l md:border-r border-gray-200 h-full overflow-y-auto pb-20 md:pb-0">
            <header class="sticky top-0 z-10 bg-white/80 backdrop-blur-sm p-4 border-b border-black/10">
                <div class="flex items-center space-x-4">
                    <a href="/index.html" class="md:hidden text-xl"><i class="bi bi-arrow-left"></i></a>
                    <div>
                        <h1 id="profile-header-name" class="text-xl font-bold">Profil</h1>
                        <p id="profile-header-posts-count" class="text-sm text-gray-500">0 Postingan</p>
                    </div>
                </div>
            </header>

            <div>
                <div id="profile-banner" class="h-48 bg-gray-300 bg-cover bg-center"></div>
                <div class="p-4">
                    <div class="flex justify-between items-start">
                        <img src="https://placehold.co/128x128/e5e7eb/e5e7eb?text= " id="profile-avatar" class="w-32 h-32 rounded-full -mt-20 border-4 border-white bg-gray-300">
                        <div id="profile-action-button-container"></div>
                    </div>
                    <div class="mt-2">
                        <h2 id="profile-fullname" class="text-2xl font-bold flex items-center"></h2>
                        <p id="profile-username" class="text-gray-500"></p>
                        <p id="profile-bio" class="mt-2 text-gray-800 whitespace-pre-wrap"></p>
                    </div>
                    <div id="follow-stats" class="mt-4 flex space-x-4 text-sm">
                        <p><strong id="following-count">0</strong> Mengikuti</p>
                        <p><strong id="followers-count">0</strong> Pengikut</p>
                    </div>
                </div>
            </div>

            <div id="timeline" class="border-t border-gray-200"></div>
        </main>
    </div>
    
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 w-full bg-white border-t border-black/10 z-20">
        <div class="flex justify-around items-center h-16">
            <a href="/index.html" class="flex flex-col items-center justify-center text-gray-500 hover:text-black"><i class="bi bi-house-door text-2xl"></i></a>
            <a href="/search.html" class="flex flex-col items-center justify-center text-gray-500 hover:text-black"><i class="bi bi-search text-2xl"></i></a>
            <a href="/notifications.html" class="relative flex flex-col items-center justify-center text-gray-500 hover:text-black">
                <i class="bi bi-bell text-2xl"></i>
                <span id="notification-badge-bottom" class="hidden notification-badge"></span>
            </a>
            <a href="#" id="profile-link-bottom" class="flex flex-col items-center justify-center text-gray-500 hover:text-black"><i class="bi bi-person text-2xl"></i></a>
        </div>
    </nav>
    
    <div id="comment-modal" class="fixed inset-0 bg-black bg-opacity-30 items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl w-full max-w-lg mx-4 border border-black/20 overflow-hidden flex flex-col max-h-[90vh] modal-box">
            <div class="flex justify-between items-center p-4 border-b border-black/10">
                <h2 class="font-bold text-lg">Postingan</h2>
                <button id="close-modal-button" class="text-2xl hover:text-gray-500 transition-colors">&times;</button>
            </div>
            <div id="modal-content" class="p-4 overflow-y-auto modal-content"></div>
            <div class="p-4 border-t border-black/10 mt-auto relative">
                <div id="replying-to-banner" class="hidden text-sm text-gray-500 mb-2"></div>
                <div class="flex space-x-2">
                    <input type="text" id="comment-input" placeholder="Tulis komentar..." class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-1 focus:ring-black">
                    <button id="submit-comment" class="bg-black text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-800 interactive-btn">Kirim</button>
                </div>
                <div id="comment-mention-popup" class="mention-popup hidden"></div>
            </div>
        </div>
    </div>

    <!-- Redesigned Edit Profile Modal -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-30 items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl w-full max-w-lg mx-4 border border-black/20 overflow-hidden flex flex-col max-h-[90vh] modal-box">
            <form id="edit-profile-form">
                <div class="flex justify-between items-center p-4 border-b border-black/10">
                    <h2 class="font-bold text-lg">Edit Profil</h2>
                    <button type="button" id="close-edit-modal-button" class="text-2xl hover:text-gray-500 transition-colors">&times;</button>
                </div>
                
                <div class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- Banner and Avatar Upload with Previews -->
                    <div class="relative h-36 rounded-lg bg-gray-200">
                        <img id="banner-preview" src="" class="w-full h-full object-cover rounded-lg hidden" alt="Pratinjau Banner">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <label for="banner-upload" class="bg-black/50 text-white rounded-full w-12 h-12 flex items-center justify-center cursor-pointer hover:bg-black/70 transition-colors">
                                <i class="bi bi-camera-fill text-xl"></i>
                            </label>
                            <input type="file" id="banner-upload" accept="image/*" class="hidden"/>
                        </div>
                    </div>

                    <div class="relative w-28 h-28 rounded-full -mt-16 ml-4 border-4 border-white bg-gray-200">
                        <img id="avatar-preview" src="" class="w-full h-full object-cover rounded-full hidden" alt="Pratinjau Avatar">
                         <div class="absolute inset-0 flex items-center justify-center">
                            <label for="avatar-upload" class="bg-black/50 text-white rounded-full w-10 h-10 flex items-center justify-center cursor-pointer hover:bg-black/70 transition-colors">
                                <i class="bi bi-camera-fill text-lg"></i>
                            </label>
                            <input type="file" id="avatar-upload" accept="image/*" class="hidden"/>
                        </div>
                    </div>
                    
                    <!-- Form Fields -->
                    <div class="pt-4 space-y-4">
                        <div>
                            <label for="full-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                            <input type="text" id="full-name-input" required class="w-full bg-gray-100 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-black">
                        </div>
                        <div>
                            <label for="username-input" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">@</span>
                                <input type="text" id="username-input" required class="w-full bg-gray-100 rounded-lg py-3 pl-8 pr-4 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                        </div>
                        <div>
                            <label for="bio-input" class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                            <textarea id="bio-input" rows="3" class="w-full bg-gray-100 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-black resize-none" placeholder="Ceritakan tentang diri Anda..."></textarea>
                        </div>
                        <div class="flex items-center justify-between pt-2">
                            <div>
                                <label for="private-account-toggle" class="block text-sm font-medium text-gray-700">Akun Privat</label>
                                <p class="text-xs text-gray-500">Jika aktif, pengguna lain harus meminta untuk mengikuti Anda.</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="private-account-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-black/10 flex justify-end">
                    <button type="submit" id="save-profile-button" class="bg-black text-white px-6 py-2 rounded-full font-semibold hover:bg-gray-800 interactive-btn disabled:opacity-50" disabled>Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>


    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-40 items-center justify-center hidden z-[60]">
        <div class="bg-white rounded-2xl w-full max-w-sm mx-4 border border-black/10 overflow-hidden modal-box text-center p-6">
            <div class="text-5xl text-red-500 mb-4"><i class="bi bi-exclamation-triangle"></i></div>
            <h2 id="confirm-modal-title" class="font-bold text-lg mb-2">Konfirmasi Aksi</h2>
            <p id="confirm-modal-message" class="text-gray-600 mb-6">Apakah Anda yakin ingin melanjutkan?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 interactive-btn">Batal</button>
                <button id="confirm-modal-confirm" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 interactive-btn">Hapus</button>
            </div>
        </div>
    </div>

    <div id="toast-notification">Tautan telah disalin!</div>
    
    <div id="global-reaction-popover"></div>

    <script>
        const { createClient } = supabase;
        let db; // Defined but not initialized

        let currentUser = null, viewedProfile = null, activePostForComment = null, activeReplyTo = null, friendshipStatus = null, currentUserProfile = null;
        let commentsById = new Map();
        let confirmCallbackHolder = () => {};
        let recentlyUpdatedPostLikes = new Set();
        let recentlyUpdatedCommentLikes = new Set();
        let reactionPopoverTimeout;
        
        const timeline = document.getElementById('timeline');
        const commentModal = document.getElementById('comment-modal'), closeModalButton = document.getElementById('close-modal-button'), modalContent = document.getElementById('modal-content'), commentInput = document.getElementById('comment-input'), submitCommentButton = document.getElementById('submit-comment'), replyingToBanner = document.getElementById('replying-to-banner');
        const editProfileModal = document.getElementById('edit-profile-modal'), closeEditModalButton = document.getElementById('close-edit-modal-button'), editProfileForm = document.getElementById('edit-profile-form'), fullNameInput = document.getElementById('full-name-input'), usernameInput = document.getElementById('username-input'), avatarUploadInput = document.getElementById('avatar-upload'), bannerUploadInput = document.getElementById('banner-upload'), bioInput = document.getElementById('bio-input'), privateAccountToggle = document.getElementById('private-account-toggle');
        const globalReactionPopover = document.getElementById('global-reaction-popover');
        
        const availableReactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢'];
        globalReactionPopover.innerHTML = availableReactions.map(emoji => `<span class="reaction-emoji" data-reaction="${emoji}">${emoji}</span>`).join('');
        
        // --- All functions are the same as before until setupModalListeners ---
        
        function createSkeletonPostElement() {
            const div = document.createElement('div');
            div.className = 'p-4 border-b border-gray-200 flex space-x-4';
            div.innerHTML = `<div class="w-12 h-12 rounded-full skeleton flex-shrink-0"></div><div class="w-full space-y-3"><div class="flex justify-between items-center"><div class="w-1/2 h-5 skeleton"></div></div><div class="w-full h-4 skeleton"></div><div class="w-3/4 h-4 skeleton"></div><div class="w-full h-48 skeleton mt-2 !rounded-xl"></div></div>`;
            return div;
        }

        function createCommentSkeletonLoader() {
            return `
                <div class="p-4 animate-pulse">
                    <div class="flex space-x-4"><div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0"></div><div class="w-full space-y-3"><div class="w-1/2 h-5 bg-gray-200 rounded"></div><div class="w-full h-4 bg-gray-200 rounded"></div><div class="w-3/4 h-4 bg-gray-200 rounded"></div></div></div><hr class="my-4 border-gray-200"><div class="flex space-x-3 mt-4"><div class="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0"></div><div class="flex-1 space-y-2"><div class="w-1/3 h-4 bg-gray-200 rounded"></div><div class="w-full h-8 bg-gray-200 rounded-xl"></div></div></div><div class="flex space-x-3 mt-4"><div class="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0"></div><div class="flex-1 space-y-2"><div class="w-1/4 h-4 bg-gray-200 rounded"></div><div class="w-full h-12 bg-gray-200 rounded-xl"></div></div></div>
                </div>
            `;
        }

        function showConfirmModal(message, onConfirm, { title = 'Konfirmasi Aksi', confirmText = 'Hapus', cancelText = 'Batal' } = {}) {
            const confirmModal = document.getElementById('confirm-modal');
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            document.getElementById('confirm-modal-confirm').textContent = confirmText;
            document.getElementById('confirm-modal-cancel').textContent = cancelText;
            confirmCallbackHolder = onConfirm;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
            setTimeout(() => confirmModal.classList.add('is-visible'), 10);
        }

        function hideConfirmModal() {
            const confirmModal = document.getElementById('confirm-modal');
            confirmModal.classList.remove('is-visible');
            setTimeout(() => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
            }, 250);
        }

        function setupModalListeners() {
            const confirmModal = document.getElementById('confirm-modal');
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');
            confirmBtn.addEventListener('click', () => { if (typeof confirmCallbackHolder === 'function') { confirmCallbackHolder(); } hideConfirmModal(); });
            cancelBtn.addEventListener('click', hideConfirmModal);
            confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) { hideConfirmModal(); } });
        }

        function setupEditModalListeners() {
            const bannerPreview = document.getElementById('banner-preview');
            const avatarPreview = document.getElementById('avatar-preview');
            const saveButton = document.getElementById('save-profile-button');

            function enableSaveButton() {
                saveButton.disabled = false;
            }

            bannerUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        bannerPreview.src = event.target.result;
                        bannerPreview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                    enableSaveButton();
                }
            });

            avatarUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        avatarPreview.src = event.target.result;
                        avatarPreview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                    enableSaveButton();
                }
            });

            fullNameInput.addEventListener('input', enableSaveButton);
            usernameInput.addEventListener('input', enableSaveButton);
            bioInput.addEventListener('input', enableSaveButton);
            privateAccountToggle.addEventListener('change', enableSaveButton);
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function setupVideoAutoplay() {
            const videos = document.querySelectorAll('#timeline video, #modal-content video');
            if (window.videoObserver) window.videoObserver.disconnect();
            if ('IntersectionObserver' in window) {
                const observerOptions = { root: null, rootMargin: '0px', threshold: 0.8 };
                const handleVideo = (entries, observer) => { entries.forEach(entry => { if (entry.isIntersecting) entry.target.play().catch(e => {}); else entry.target.pause(); }); };
                window.videoObserver = new IntersectionObserver(handleVideo, observerOptions);
                videos.forEach(video => window.videoObserver.observe(video));
            }
        }
        
        async function initialize() {
            const { data: { session } } = await db.auth.getSession();
            if (!session) { window.location.href = '/auth.html'; return; }
            currentUser = session.user;

            const { data: profileData } = await db.from('profiles').select('username').eq('id', currentUser.id).single();
            if (profileData) {
                currentUserProfile = profileData;
                document.getElementById('profile-link-sidebar').href = `/@${currentUserProfile.username}`;
                document.getElementById('profile-link-bottom').href = `/@${currentUserProfile.username}`;
            }

            // --- JAVASCRIPT ROUTING LOGIC ---
            const path = window.location.pathname;
            const pathSegments = path.split('/').filter(Boolean);
            let usernameFromPath = null;

            const atSegment = pathSegments.find(segment => segment.startsWith('@'));
            if (atSegment) {
                usernameFromPath = atSegment.substring(1);
            }
            
            let userIdToFetch;

            if (usernameFromPath) {
                const { data: profile, error } = await db.from('profiles').select('id').eq('username', usernameFromPath).single();
                if (error || !profile) {
                    console.error("Profil tidak ditemukan untuk username:", usernameFromPath);
                    document.body.innerHTML = `<div class="p-8 text-center"><h1 class="font-bold text-xl">404 - Pengguna Tidak Ditemukan</h1><p class="text-gray-600">Profil dengan @${usernameFromPath} tidak ada.</p> <a href="/index.html" class="text-blue-500 mt-4 inline-block">Kembali ke Beranda</a></div>`;
                    return;
                }
                userIdToFetch = profile.id;
            } else {
                 userIdToFetch = currentUser.id;
            }
            // --- END ROUTING LOGIC ---

            const urlParams = new URLSearchParams(window.location.search);
            const postIdFromUrl = urlParams.get('post_id');
            
            await fetchProfileData(userIdToFetch);
            
            setupModalListeners();
            setupEditModalListeners();
            if (postIdFromUrl) openCommentModal(postIdFromUrl);

            subscribeToChanges();
            subscribeToNotifications();
            highlightActiveNav(userIdToFetch);
        }
        
        function processBio(text) {
            if (!text) return '';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const mentionRegex = /@(\w+)/g;
            let processedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">$1</a>');
            processedText = processedText.replace(mentionRegex, '<a href="/@$1" class="text-blue-500 hover:underline">@$1</a>');
            return processedText;
        }

        async function fetchProfileData(userId) {
            const { data: profile, error } = await db.from('profiles').select('*').eq('id', userId).single();
            if (error || !profile) { console.error('Error fetching profile:', error); timeline.innerHTML = '<p class="p-4 text-center text-red-500">Gagal memuat profil.</p>'; return; }
            viewedProfile = profile;
            
            const userInitial = profile.full_name ? profile.full_name.charAt(0).toUpperCase() : '?';
            document.getElementById('profile-header-name').textContent = profile.full_name;
            const fullNameElement = document.getElementById('profile-fullname');
            fullNameElement.innerHTML = `${profile.full_name} ${profile.is_verified ? '<span class="ml-2 text-blue-500"><i class="bi bi-patch-check-fill"></i></span>' : ''}`;
            
            document.getElementById('profile-avatar').src = profile.profile_avatar_url || `https://placehold.co/128x128/1A1A1A/FFFFFF?text=${userInitial}&font=inter`;
            document.getElementById('profile-username').textContent = `@${profile.username}`;
            document.getElementById('profile-bio').innerHTML = processBio(profile.bio);

            if (profile.banner_url) document.getElementById('profile-banner').style.backgroundImage = `url(${profile.banner_url})`;

            await updateFollowStats(userId);
            
            if (currentUser.id !== profile.id) {
                const { data: follows, error: followError } = await db.from('follows').select('status').eq('follower_id', currentUser.id).eq('following_id', viewedProfile.id).order('created_at', { ascending: false }).limit(1);
                if (followError) console.error("Error fetching friendship status:", followError);
                friendshipStatus = follows && follows.length > 0 ? follows[0].status : null;
            }
            
            renderActionButton();
            await fetchUserPosts(userId);
        }
        
        async function fetchUserPosts(userId) {
            timeline.innerHTML = '';
            
            if (viewedProfile.is_private && friendshipStatus !== 'accepted' && currentUser.id !== viewedProfile.id) {
                timeline.innerHTML = `<div class="text-center p-8"><i class="bi bi-lock-fill text-4xl text-gray-400"></i><h3 class="font-bold mt-4">Akun Ini Privat</h3><p class="text-gray-500">Ikuti untuk melihat postingan mereka.</p></div>`;
                document.getElementById('profile-header-posts-count').textContent = 'Postingan disembunyikan';
                return;
            }

            for (let i = 0; i < 3; i++) timeline.appendChild(createSkeletonPostElement());

            const { data: posts, error, count } = await db.from('posts').select(`*, profiles(*), likes(user_id), reactions(*), comments(count), poll_votes(user_id, option_text)`, { count: 'exact' }).eq('user_id', userId).order('created_at', { ascending: false });
            
            timeline.innerHTML = '';
            if (error) { console.error('Error fetching user posts:', error.message || error); return; }
            
            document.getElementById('profile-header-posts-count').textContent = `${count} Postingan`;
            
            if (posts.length === 0) {
                timeline.innerHTML = '<p class="p-4 text-center text-gray-500">Belum ada postingan.</p>';
            } else {
                const postElements = posts.map((post, index) => {
                    const postElement = createPostElement(post);
                    postElement.style.animationDelay = `${index * 100}ms`;
                    return postElement;
                });
                timeline.append(...postElements);
            }
            setupVideoAutoplay();
        }
        
        function renderActionButton() {
            const actionButtonContainer = document.getElementById('profile-action-button-container');
            if (currentUser.id === viewedProfile.id) {
                actionButtonContainer.innerHTML = `<button id="edit-profile-button" class="border border-gray-300 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 interactive-btn">Edit Profil</button>`;
                document.getElementById('edit-profile-button').addEventListener('click', openEditModal);
            } else {
                let buttonHtml = '';
                if (friendshipStatus === 'accepted') {
                    buttonHtml = `<button id="follow-action-button" data-action="unfollow" class="bg-white text-black border border-gray-300 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 interactive-btn">Mengikuti</button>`;
                } else if (friendshipStatus === 'pending') {
                    buttonHtml = `<button id="follow-action-button" data-action="cancel" class="bg-gray-200 text-gray-800 border border-gray-300 px-4 py-2 rounded-full font-semibold hover:bg-gray-300 interactive-btn">Batalkan Permintaan</button>`;
                } else {
                    buttonHtml = `<button id="follow-action-button" data-action="follow" class="bg-black text-white px-4 py-2 rounded-full font-semibold hover:bg-gray-800 interactive-btn">Ikuti</button>`;
                }
                actionButtonContainer.innerHTML = buttonHtml;
                document.getElementById('follow-action-button')?.addEventListener('click', handleFollowAction);
            }
        }

        async function handleFollowAction(e) {
            const button = e.target;
            const action = button.dataset.action;
            button.disabled = true;

            try {
                if (action === 'unfollow' || action === 'cancel') {
                    await db.from('follows').delete().match({ follower_id: currentUser.id, following_id: viewedProfile.id });
                    friendshipStatus = null;
                } else if (action === 'follow') {
                    if (viewedProfile.is_private) {
                        await db.from('follows').insert({ follower_id: currentUser.id, following_id: viewedProfile.id, status: 'pending' });
                        await db.from('notifications').insert({ recipient_id: viewedProfile.id, actor_id: currentUser.id, notification_type: 'follow_request' });
                        friendshipStatus = 'pending';
                    } else {
                        await db.from('follows').insert({ follower_id: currentUser.id, following_id: viewedProfile.id, status: 'accepted' });
                        await db.from('notifications').insert({ recipient_id: viewedProfile.id, actor_id: currentUser.id, notification_type: 'follow' });
                        friendshipStatus = 'accepted';
                    }
                }
            } catch (error) {
                 console.error("Error handling follow action:", error.message || error);
            } finally {
                renderActionButton();
                await updateFollowStats(viewedProfile.id);
                if (action === 'follow' && !viewedProfile.is_private) {
                    await fetchUserPosts(viewedProfile.id); // Refresh posts to show content
                } else if (action === 'unfollow' && viewedProfile.is_private) {
                    await fetchUserPosts(viewedProfile.id); // Refresh to hide content
                }
            }
        }
        
        async function updateFollowStats(userId) {
            const { count: followingCount } = await db.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', userId).eq('status', 'accepted');
            const { count: followersCount } = await db.from('follows').select('*', { count: 'exact', head: true }).eq('following_id', userId).eq('status', 'accepted');
            document.getElementById('following-count').textContent = followingCount || 0;
            document.getElementById('followers-count').textContent = followersCount || 0;
        }

        function highlightActiveNav(viewedUserId) {
            const sidebarLinks = document.querySelectorAll('aside nav a');
            sidebarLinks.forEach(link => {
                link.classList.remove('font-bold', 'text-black');
                link.querySelector('i').className = link.querySelector('i').className.replace('-fill', '');
            });
            
            const activeSidebarLink = document.querySelector(`aside nav a[href*="/@${currentUserProfile.username}"]`);
            if (activeSidebarLink && viewedUserId === currentUser.id) {
                activeSidebarLink.classList.add('font-bold', 'text-black');
                activeSidebarLink.querySelector('i').className = activeSidebarLink.querySelector('i').className.replace('person', 'person-fill');
            }

            const bottomNav = document.getElementById('bottom-nav');
            if (!bottomNav) return;
            const links = bottomNav.querySelectorAll('a');
            links.forEach(link => {
                const icon = link.querySelector('i');
                link.classList.add('text-gray-500');
                link.classList.remove('text-black');
                icon.className = icon.className.replace('-fill', '');
            });

            const activeBottomLink = document.querySelector(`#bottom-nav a[href*="/@${currentUserProfile.username}"]`);
            if (activeBottomLink && viewedUserId === currentUser.id) {
                activeBottomLink.classList.remove('text-gray-500');
                activeBottomLink.classList.add('text-black');
                activeBottomLink.querySelector('i').className = activeBottomLink.querySelector('i').className.replace('person', 'person-fill');
            }
        }

        function subscribeToChanges() {
            db.channel('public-changes-profile')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'likes' }, (payload) => handleLikeChange(payload.new?.post_id || payload.old?.post_id))
              .on('postgres_changes', { event: '*', schema: 'public', table: 'reactions' }, (payload) => {
                  const postId = payload.new?.post_id || payload.old?.post_id;
                  updatePostReactionsUI(postId);
                  if (activePostForComment?.id == postId) updatePostReactionsUI(postId, modalContent);
              })
              .on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, (payload) => {
                  if (payload.eventType === 'INSERT') handleCommentInsert(payload.new);
                  else if (payload.eventType === 'UPDATE') handleCommentLikeChange(payload.new.id);
              })
              .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'posts' }, async (payload) => {
                    const postId = payload.new.id;
                    const postElement = document.getElementById(`post-${postId}`);
                    const modalPostElement = document.querySelector(`#modal-content #post-${postId}`);
                    if (payload.new.is_poll && (postElement || modalPostElement)) {
                        const { data: updatedPost, error } = await db.from('posts').select('poll_options, poll_votes(user_id, option_text)').eq('id', postId).single();
                        if (error) return;
                        if (postElement) updatePollUI(postId, updatedPost.poll_options, updatedPost.poll_votes);
                        if (modalPostElement) updatePollUI(postId, updatedPost.poll_options, updatedPost.poll_votes, modalContent);
                    }
              })
              .subscribe();
        }

        async function subscribeToNotifications() {
            const updateBadge = async () => {
                const { count } = await db.from('notifications').select('*', { count: 'exact', head: true }).eq('recipient_id', currentUser.id).eq('is_read', false);
                const badges = [document.getElementById('notification-badge-sidebar'), document.getElementById('notification-badge-bottom')];
                badges.forEach(b => { if (b) { if (count > 0) b.classList.remove('hidden'); else b.classList.add('hidden'); } });
            };
            await updateBadge();
            db.channel('public:notifications').on('postgres_changes', { event: '*', schema: 'public', table: 'notifications', filter: `recipient_id=eq.${currentUser.id}` }, updateBadge).subscribe();
        }
        
        async function handleLikeChange(postId, elementContext = null) {
            if (recentlyUpdatedPostLikes.has(postId)) return;
            const postElement = elementContext || document.getElementById(`post-${postId}`);
            if (!postElement) return;
            const likeButton = postElement.querySelector('.like-button:not(.like-comment-button)');
            if (!likeButton) return;
            const { data, error } = await db.from('posts').select(`likes(user_id)`).eq('id', postId).single();
            if (error) return console.error('Error fetching updated likes:', error);
            const likeCountSpan = likeButton.querySelector('.like-count');
            const icon = likeButton.querySelector('i');
            const likes = data.likes || [];
            const userHasLiked = likes.some(like => like.user_id === currentUser.id);
            likeCountSpan.textContent = likes.length;
            likeButton.dataset.liked = userHasLiked;
            likeButton.classList.toggle('text-red-500', userHasLiked);
            icon.classList.toggle('bi-heart-fill', userHasLiked);
            icon.classList.toggle('bi-heart', !userHasLiked);
        }

        async function handleCommentLikeChange(commentId) {
            if (recentlyUpdatedCommentLikes.has(commentId)) return;
            const commentElement = document.getElementById(`comment-${commentId}`);
            if (!commentElement) return;
            const { data: comment, error } = await db.from('comments').select('liked_by').eq('id', commentId).single();
            if (error) return;
            const likeButton = commentElement.querySelector('.like-comment-button');
            if (!likeButton) return;
            const liked_by = comment.liked_by || [];
            const userHasLiked = liked_by.includes(currentUser.id);
            likeButton.dataset.liked = userHasLiked;
            likeButton.querySelector('.comment-like-count').textContent = liked_by.length;
            const icon = likeButton.querySelector('i');
            likeButton.classList.toggle('text-red-500', userHasLiked);
            icon.classList.toggle('bi-heart-fill', userHasLiked);
            icon.classList.toggle('bi-heart', !userHasLiked);
        }

        function handleCommentInsert(newComment) {
            const postElement = document.getElementById(`post-${newComment.post_id}`);
            if(postElement) postElement.querySelector('.comment-count').textContent = parseInt(postElement.querySelector('.comment-count').textContent) + 1;
            if (commentModal.classList.contains('is-visible') && activePostForComment && newComment.post_id === activePostForComment.id) openCommentModal(activePostForComment.id);
        }

        function createPostElement(post) { 
            const div = document.createElement('div');
            div.className = 'p-4 border-b border-gray-200 flex space-x-4 post-enter-animation';
            div.id = `post-${post.id}`;
            const profile = post.profiles;
            if (!profile) return div;
            const userHasLiked = (post.likes || []).some(like => like.user_id === currentUser.id);
            const likeCount = (post.likes || []).length;
            const commentCount = post.comments && post.comments[0] ? post.comments[0].count : 0;
            const userInitial = profile.full_name ? profile.full_name.charAt(0).toUpperCase() : '?';
            const profilePicUrl = profile.profile_avatar_url || `https://placehold.co/48x48/1A1A1A/FFFFFF?text=${userInitial}&font=inter`;
            
            const processedContent = post.content.replace(/@(\w+)|#(\w+)/g, (match, mention, hashtag) => {
                if (mention) return `<a href="/@${mention}" class="text-blue-500 hover:underline">@${mention}</a>`;
                if (hashtag) return `<a href="/index.html?hashtag=${hashtag.toLowerCase()}" class="text-blue-500 hover:underline">#${hashtag}</a>`;
            });

            let copiedLabelHtml = '';
            if (post.last_copied_at) {
                 const copiedDate = new Date(post.last_copied_at);
                 const createdDate = new Date(post.created_at);
                 if (Date.now() - copiedDate.getTime() < 5 * 60 * 1000 && Math.abs(copiedDate.getTime() - createdDate.getTime()) > 1000) {
                    copiedLabelHtml = `<div class="copied-post-label"><i class="bi bi-link-45deg"></i> Baru saja dibagikan</div>`;
                 }
            }
            
            let postContentHtml = '';
            if (post.is_poll) {
                const pollVotes = post.poll_votes || [];
                const userVote = pollVotes.find(v => v.user_id === currentUser.id);
                const totalVotes = (post.poll_options || []).reduce((sum, opt) => sum + (opt.votes || 0), 0);
                const optionsHtml = (post.poll_options || []).map(option => {
                    const percent = totalVotes > 0 ? Math.round(((option.votes || 0) / totalVotes) * 100) : 0;
                    const hasVotedThis = userVote && userVote.option_text === option.option;
                    return `<div class="poll-option ${hasVotedThis ? 'user-voted' : ''}" data-option="${option.option}" data-post-id="${post.id}">${userVote ? `<div class="poll-progress" style="width: ${percent}%;"></div>` : ''}<div class="poll-option-content"><span>${option.option}</span>${userVote ? `<span class="poll-option-percent">${percent}%</span>` : ''}</div></div>`;
                }).join('');
                postContentHtml = `<p class="my-2 whitespace-pre-wrap">${processedContent}</p><div class="mt-3 space-y-2 poll-container" id="poll-${post.id}"><p class="font-bold text-lg">${post.poll_question}</p>${optionsHtml}<p class="text-xs text-gray-500 text-right">${totalVotes} suara</p></div>`;
            } else if (post.is_full_text) {
                postContentHtml = `<div class="my-2 p-8 rounded-2xl flex items-center justify-center text-center text-white ${post.bg_color} min-h-[12rem]"><p class="text-2xl ${post.font_family}">${processedContent}</p></div>`;
            } else {
                let mediaHtml = '';
                if (post.image_url) mediaHtml = `<img src="${post.image_url}" loading="lazy" class="mt-2 rounded-2xl border border-black/10 w-full object-cover">`;
                else if (post.video_url) mediaHtml = `<div class="mt-2 custom-video-player" data-post-id="${post.id}"><video src="${post.video_url}" preload="metadata" class="w-full h-full" loop muted playsinline onerror="this.closest('.custom-video-player').innerHTML = '<div class=\\'text-center p-8 bg-gray-100 rounded-2xl text-gray-500 flex items-center justify-center min-h-[200px]\\'>Gagal memuat video.</div>'"></video><div class="video-controls-overlay"><button class="play-pause-btn interactive-btn"><i class="bi bi-play-fill text-3xl"></i></button><button class="volume-btn"><i class="bi bi-volume-mute-fill"></i></button></div><div class="video-progress-bar"><div class="video-progress-filled"></div></div></div>`;
                postContentHtml = `<p class="my-2 whitespace-pre-wrap">${processedContent}</p>${mediaHtml}`;
            }
            const reactions = post.reactions || [];
            const reactionCounts = reactions.reduce((acc, r) => { acc[r.reaction_type] = (acc[r.reaction_type] || 0) + 1; return acc; }, {});
            const sortedReactions = Object.entries(reactionCounts).sort((a, b) => b[1] - a[1]);
            const userReaction = reactions.find(r => r.user_id === currentUser.id);
            const reactionSummaryHtml = sortedReactions.map(([type, count]) => `<div class="reaction-pill ${userReaction?.reaction_type === type ? 'user-reacted' : ''}"><span>${type}</span><span class="font-bold ml-1">${count}</span></div>`).join('');
            
            div.innerHTML = `
                <div><a href="/@${profile.username}"><img src="${profilePicUrl}" alt="Profile Picture" class="w-12 h-12 rounded-full bg-gray-200" loading="lazy"></a></div>
                <div class="w-full">
                    <div class="flex justify-between items-start">
                        <div><a href="/@${profile.username}" class="hover:underline"><p class="font-bold flex items-center">${profile.full_name} ${profile.is_verified ? '<span class="ml-1 text-blue-500"><i class="bi bi-patch-check-fill"></i></span>' : ''}<span class="ml-2 text-sm text-gray-500 font-normal">@${profile.username}</span></p></a><p class="text-xs text-gray-500">${new Date(post.created_at).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' })}</p></div>
                        ${post.user_id === currentUser.id ? `<button data-post-id="${post.id}" class="delete-post-button text-gray-400 hover:text-red-500 text-xl">&times;</button>` : ''}
                    </div>
                    ${copiedLabelHtml}
                    ${postContentHtml}
                    <div class="reaction-summary">${reactionSummaryHtml}</div>
                    <div class="flex items-center justify-around text-gray-500 mt-3">
                        <button data-post-id="${post.id}" class="comment-button flex items-center space-x-1 icon-btn hover:text-blue-500 interactive-btn"><i class="bi bi-chat text-xl"></i><span class="comment-count">${commentCount}</span></button>
                        <button data-post-id="${post.id}" data-liked="${userHasLiked}" class="like-button flex items-center space-x-1 icon-btn ${userHasLiked ? 'text-red-500' : 'hover:text-red-500'} interactive-btn"><i class="bi ${userHasLiked ? 'bi-heart-fill' : 'bi-heart'} text-xl"></i><span class="like-count">${likeCount}</span></button>
                        <button data-post-id="${post.id}" class="copy-link-button icon-btn hover:text-green-500 interactive-btn"><i class="bi bi-link-45deg text-xl"></i></button>
                        <div data-post-id="${post.id}" class="reactions-container relative"><button class="icon-btn hover:text-yellow-500 ${userReaction ? 'text-yellow-500' : ''} interactive-btn"><i class="bi bi-emoji-smile text-xl"></i></button></div>
                    </div>
                </div>`;
            return div;
        }

        async function updatePostReactionsUI(postId, elementContext = null) {
            const postElement = elementContext ? elementContext.querySelector(`[id='post-${postId}']`) : document.getElementById(`post-${postId}`);
            if (!postElement) return;
            const { data: reactions, error } = await db.from('reactions').select('*').eq('post_id', postId);
            if (error) return;
            const reactionCounts = reactions.reduce((acc, r) => { acc[r.reaction_type] = (acc[r.reaction_type] || 0) + 1; return acc; }, {});
            const sortedReactions = Object.entries(reactionCounts).sort((a, b) => b[1] - a[1]);
            const userReaction = reactions.find(r => r.user_id === currentUser.id);
            const summaryContainer = postElement.querySelector('.reaction-summary');
            if (summaryContainer) summaryContainer.innerHTML = sortedReactions.map(([type, count]) => `<div class="reaction-pill ${userReaction?.reaction_type === type ? 'user-reacted' : ''}"><span>${type}</span><span class="font-bold ml-1">${count}</span></div>`).join('');
            const reactionButton = postElement.querySelector('.reactions-container button');
            if (reactionButton) reactionButton.classList.toggle('text-yellow-500', !!userReaction);
        }

        function updatePollUI(postId, pollOptions, pollVotes, elementContext = document) {
            const pollContainer = elementContext.querySelector(`#poll-${postId}`);
            if (!pollContainer) return;
            const userVote = (pollVotes || []).find(v => v.user_id === currentUser.id);
            const totalVotes = (pollOptions || []).reduce((sum, opt) => sum + (opt.votes || 0), 0);
            pollContainer.querySelectorAll('.poll-option').forEach(optionEl => {
                const optionText = optionEl.dataset.option;
                const optionData = pollOptions.find(o => o.option === optionText);
                if (!optionData) return;
                optionEl.classList.toggle('user-voted', userVote && userVote.option_text === optionText);
                const percent = totalVotes > 0 ? Math.round(((optionData.votes || 0) / totalVotes) * 100) : 0;
                let progressEl = optionEl.querySelector('.poll-progress');
                let percentEl = optionEl.querySelector('.poll-option-percent');
                if (userVote) {
                    if (!progressEl) { progressEl = document.createElement('div'); progressEl.className = 'poll-progress'; optionEl.prepend(progressEl); }
                    if (!percentEl) { percentEl = document.createElement('span'); percentEl.className = 'poll-option-percent'; optionEl.querySelector('.poll-option-content').appendChild(percentEl); }
                    percentEl.textContent = `${percent}%`;
                    setTimeout(() => { if (progressEl) progressEl.style.width = `${percent}%`; }, 10);
                } else {
                    if (progressEl) { progressEl.style.width = '0%'; progressEl.addEventListener('transitionend', () => progressEl.remove(), { once: true }); }
                    if (percentEl) percentEl.remove();
                }
            });
            const totalVotesEl = pollContainer.querySelector('.text-right');
            if(totalVotesEl) totalVotesEl.textContent = `${totalVotes} suara`;
        }
        
        async function updatePostPollData(postId) {
            const { data: allVotes, error: votesError } = await db.from('poll_votes').select('option_text').eq('post_id', postId);
            if (votesError) return console.error('Error fetching votes:', votesError);
            const { data: post, error: postError } = await db.from('posts').select('poll_options').eq('id', postId).single();
            if (postError) return console.error('Error fetching post data:', postError);
            const newPollOptions = post.poll_options.map(option => ({ ...option, votes: 0 }));
            allVotes.forEach(vote => { const optionToUpdate = newPollOptions.find(opt => opt.option === vote.option_text); if (optionToUpdate) optionToUpdate.votes++; });
            const { error: updateError } = await db.from('posts').update({ poll_options: newPollOptions }).eq('id', postId);
            if (updateError) console.error('Error updating post table:', updateError);
        }

        function createCommentElement(comment, profile, postOwnerId, replyCount = 0) {
            const div = document.createElement('div');
            div.className = `flex space-x-3 mt-4 comment-container ${comment.is_pinned ? 'comment-pinned' : ''}`;
            div.id = `comment-${comment.id}`;
            const userInitial = profile.full_name.charAt(0).toUpperCase();
            const profilePicUrl = profile.profile_avatar_url || `https://placehold.co/40x40/1A1A1A/FFFFFF?text=${userInitial}&font=inter`;
            const liked_by = comment.liked_by || [];
            const userHasLiked = liked_by.includes(currentUser.id);
            const likeCount = liked_by.length;
            const isPostOwner = currentUser.id === postOwnerId;
            const isCommentOwner = currentUser.id === comment.user_id;
            let replyToMentionSpan = '';
            if (comment.reply_to_username) replyToMentionSpan = `<a href="/@${comment.reply_to_username}" class="text-blue-500 hover:underline mr-1">@${comment.reply_to_username}</a>`;
            const processedContent = comment.content.replace(/@(\w+)/g, '<a href="/@$1" class="text-blue-500 hover:underline">@$1</a>');
            const repliesContainerHtml = `<div class="replies-container hidden pl-10"></div>`;
            const showRepliesButton = replyCount > 0 ? `<button class="toggle-replies-button text-sm text-blue-500 font-semibold mt-2">Lihat ${replyCount} balasan</button>` : '';
            div.innerHTML = `<img src="${profilePicUrl}" loading="lazy" class="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0"><div class="flex-1"><div class="bg-gray-100 rounded-xl p-3">${comment.is_pinned ? '<div class="text-xs text-gray-500 font-semibold mb-2 flex items-center"><i class="bi bi-pin-angle-fill mr-1.5"></i>Disematkan oleh Pemilik</div>' : ''}<div class="flex justify-between items-center"><a

