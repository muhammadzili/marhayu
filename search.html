<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencarian - Marhayu</title>
    <link rel="shortcut icon" href="assets/marhayu-white.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        html, body { 
            overflow: hidden; 
            height: 100%;
        }
        body { font-family: 'Inter', sans-serif; }
        .font-lora { font-family: 'Lora', serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .sidebar-nav::-webkit-scrollbar, #search-results::-webkit-scrollbar, .modal-content::-webkit-scrollbar { display: none; }
        .sidebar-nav, #search-results, .modal-content { -ms-overflow-style: none; scrollbar-width: none; }
        .notification-badge { position: absolute; top: 0.5rem; right: 0.5rem; width: 0.75rem; height: 0.75rem; border-radius: 9999px; background-color: #ef4444; border: 2px solid white; }
        .skeleton { background-color: #e5e7eb; border-radius: 0.5rem; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .result-enter-animation { animation: fadeInSlideUp 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .interactive-btn { transition: transform 0.1s ease-out, background-color 0.2s ease; }
        .interactive-btn:active { transform: scale(0.95); }

        /* Styles copied from index/profile for post consistency */
        .custom-video-player { position: relative; background-color: #000; border-radius: 1rem; overflow: hidden; line-height: 0; }
        .custom-video-player video { display: block; margin: 0 auto; width: auto; height: auto; max-width: 100%; max-height: 560px; border-radius: 1rem; }
        .video-controls-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease; cursor: pointer; }
        .custom-video-player:hover .video-controls-overlay { opacity: 1; }
        .video-controls-overlay .play-pause-btn { background: rgba(0,0,0,0.5); border: 2px solid white; color: white; width: 4rem; height: 4rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        .volume-btn { position: absolute; bottom: 0.75rem; right: 0.75rem; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; text-shadow: 0 0 5px black; z-index: 10; }
        .video-progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background-color: rgba(255,255,255,0.3); cursor: pointer; }
        .video-progress-filled { width: 0%; height: 100%; background-color: #fff; }
        .reaction-summary { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
        .reaction-pill { display: flex; align-items: center; gap: 0.25rem; background-color: #eef2ff; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .user-reacted { background-color: #c7d2fe; border: 1px solid #818cf8; }
        .poll-option { position: relative; border: 1px solid #d1d5db; border-radius: 0.75rem; padding: 0.75rem; cursor: pointer; overflow: hidden; transition: border-color 0.2s, background-color 0.2s; }
        .poll-option:hover { border-color: #6366f1; }
        .poll-option.user-voted { border-color: #4f46e5; background-color: #e0e7ff; font-weight: 500; }
        .poll-progress { position: absolute; top: 0; left: 0; height: 100%; background-color: #c7d2fe; width: 0%; z-index: 1; transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1); }
        .poll-option-content { position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; }
        .poll-option-percent { font-weight: 600; }
        #comment-modal { transition: opacity 0.25s ease, visibility 0.25s ease; opacity: 0; visibility: hidden; }
        #comment-modal.is-visible { opacity: 1; visibility: visible; }
        #comment-modal .modal-box { transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0.95) translateY(15px); }
        #comment-modal.is-visible .modal-box { transform: scale(1) translateY(0); }
        
        #tab-container { position: relative; }
        .tab-btn { position: relative; z-index: 10; }
        #tab-indicator { position: absolute; bottom: 0; height: 2px; background-color: black; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-white text-black">

    <div class="container mx-auto max-w-4xl flex flex-row md:gap-8 h-full">
        <!-- Sidebar -->
        <aside class="hidden md:block w-[280px] flex-shrink-0 pt-8 pr-4">
             <a href="index.html"><img src="https://mage.mzili.my.id/uploads/img_68c50e457ef002.30239660.png" alt="Logo Marhayu" class="h-10 mb-8"></a>
            <nav class="space-y-1 text-lg sidebar-nav">
                <a href="index.html" class="flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="bi bi-house-door text-2xl"></i><span>Beranda</span>
                </a>
                <a href="search.html" class="flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 transition-colors font-bold text-black">
                    <i class="bi bi-search-heart-fill text-2xl"></i><span>Pencarian</span>
                </a>
                 <a href="notifications.html" class="relative flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="bi bi-bell text-2xl"></i><span>Notifikasi</span>
                    <span id="notification-badge-sidebar" class="hidden notification-badge"></span>
                </a>
                <a href="#" id="profile-link-sidebar" class="flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="bi bi-person text-2xl"></i><span>Profil</span>
                </a>
            </nav>
            <button id="logout-button" class="mt-8 w-full bg-black text-white py-2 rounded-full font-semibold hover:bg-gray-800 transition-colors interactive-btn">Keluar</button>
        </aside>

        <!-- Main Search Content -->
        <main class="w-full min-w-0 md:border-l md:border-r border-gray-200 h-full flex flex-col">
            <header class="sticky top-0 z-10 bg-white/80 backdrop-blur-sm p-4 pt-2 md:pt-4 border-b border-black/10 flex-shrink-0">
                <div class="relative">
                    <i class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Cari di Marhayu..." class="w-full bg-gray-100 rounded-full py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-black">
                </div>
            </header>

            <div id="tab-container" class="flex border-b border-gray-200 relative">
                <button data-tab="all" class="tab-btn flex-1 text-center py-3 font-semibold text-black transition-colors">Semua</button>
                <button data-tab="users" class="tab-btn flex-1 text-center py-3 font-semibold text-gray-500 transition-colors">Pengguna</button>
                <button data-tab="posts" class="tab-btn flex-1 text-center py-3 font-semibold text-gray-500 transition-colors">Postingan</button>
                <button data-tab="hashtags" class="tab-btn flex-1 text-center py-3 font-semibold text-gray-500 transition-colors">Hashtag</button>
                <div id="tab-indicator"></div>
            </div>

            <!-- Search Results -->
            <div id="search-results" class="flex-grow overflow-y-auto">
                <p class="p-4 text-center text-gray-500">Cari teman, postingan, atau tagar di Marhayu.</p>
            </div>
        </main>
    </div>

    <!-- Bottom Navigation Bar (Mobile) -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 w-full bg-white border-t border-black/10 z-20">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center justify-center text-gray-500 hover:text-black">
                <i class="bi bi-house-door text-2xl"></i>
            </a>
            <a href="search.html" class="flex flex-col items-center justify-center text-gray-500 hover:text-black">
                <i class="bi bi-search text-2xl"></i>
            </a>
            <a href="notifications.html" class="relative flex flex-col items-center justify-center text-gray-500 hover:text-black">
                <i class="bi bi-bell text-2xl"></i>
                <span id="notification-badge-bottom" class="hidden notification-badge"></span>
            </a>
            <a href="#" id="profile-link-bottom" class="flex flex-col items-center justify-center text-gray-500 hover:text-black">
                <i class="bi bi-person text-2xl"></i>
            </a>
        </div>
    </nav>
    
    <!-- Comment Modal (Copied from other pages for consistency) -->
    <div id="comment-modal" class="fixed inset-0 bg-black bg-opacity-30 items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl w-full max-w-lg mx-4 border border-black/20 overflow-hidden flex flex-col max-h-[90vh] modal-box">
            <div class="flex justify-between items-center p-4 border-b border-black/10">
                <h2 class="font-bold text-lg">Postingan</h2>
                <button id="close-modal-button" class="text-2xl hover:text-gray-500 transition-colors">&times;</button>
            </div>
            <div id="modal-content" class="p-4 overflow-y-auto modal-content"></div>
             <div class="p-4 border-t border-black/10 mt-auto relative">
                 <div id="replying-to-banner" class="hidden text-sm text-gray-500 mb-2"></div>
                <div class="flex space-x-2">
                    <input type="text" id="comment-input" placeholder="Tulis komentar..." class="w-full px-4 py-2 border border-black/20 rounded-lg focus:outline-none focus:ring-1 focus:ring-black">
                    <button id="submit-comment" class="bg-black text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-800 interactive-btn">Kirim</button>
                </div>
                 <div id="comment-mention-popup" class="mention-popup hidden"></div>
            </div>
        </div>
    </div>


    <script>
        const { createClient } = supabase;
        let db; 
        let currentUser = null;
        let activeSearchTab = 'all';
        
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results');
        const tabContainer = document.getElementById('tab-container');

        function highlightActiveNav() {
            const bottomNav = document.getElementById('bottom-nav');
            if (!bottomNav) return;

            const links = bottomNav.querySelectorAll('a');
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';

            links.forEach(link => {
                const linkPage = link.getAttribute('href').split('/').pop();
                const icon = link.querySelector('i');

                if (linkPage === currentPage || (currentPage === 'search.html' && linkPage === 'search.html')) {
                    link.classList.remove('text-gray-500');
                    link.classList.add('text-black');
                    if (icon.classList.contains('bi-house-door')) icon.className = 'bi bi-house-door-fill text-2xl';
                    else if (icon.classList.contains('bi-search')) icon.className = 'bi bi-search-heart-fill text-2xl';
                    else if (icon.classList.contains('bi-bell')) icon.className = 'bi bi-bell-fill text-2xl';
                    else if (icon.classList.contains('bi-person')) icon.className = 'bi bi-person-fill text-2xl';
                }
            });
        }
        
        async function subscribeToNotifications() {
            const updateBadge = async () => {
                const { count } = await db.from('notifications').select('*', { count: 'exact', head: true }).eq('recipient_id', currentUser.id).eq('is_read', false);
                 const badges = [document.getElementById('notification-badge-sidebar'), document.getElementById('notification-badge-bottom')];
                badges.forEach(badge => {
                    if (!badge) return;
                    if (count > 0) {
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                });
            };
            await updateBadge();
            db.channel('public:notifications')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'notifications', filter: `recipient_id=eq.${currentUser.id}` }, updateBadge)
              .subscribe();
        }

        async function initialize() {
            const { data: { session } } = await db.auth.getSession();
            if (!session) {
                window.location.href = 'auth.html';
                return;
            }
            currentUser = session.user;
            document.getElementById('profile-link-sidebar').href = `profile.html?user_id=${currentUser.id}`;
            document.getElementById('profile-link-bottom').href = `profile.html?user_id=${currentUser.id}`;
            highlightActiveNav();
            subscribeToNotifications();
            updateTabUI();
            window.addEventListener('resize', updateTabUI);
        }

        function createSkeletonResult(type = 'user') {
            const div = document.createElement('div');
            if(type === 'user') {
                div.className = 'flex items-center p-4 border-b border-black/10';
                div.innerHTML = `
                    <div class="w-12 h-12 rounded-full skeleton mr-4"></div>
                    <div class="flex-1 space-y-2">
                        <div class="w-1/3 h-5 skeleton"></div>
                        <div class="w-1/4 h-4 skeleton"></div>
                    </div>
                `;
            } else if (type === 'post') {
                 div.className = 'p-4 border-b border-gray-200 flex space-x-4';
                 div.innerHTML = `<div class="w-12 h-12 rounded-full skeleton flex-shrink-0"></div><div class="w-full space-y-3"><div class="flex justify-between items-center"><div class="w-1/2 h-5 skeleton"></div></div><div class="w-full h-4 skeleton"></div><div class="w-3/4 h-4 skeleton"></div><div class="w-full h-48 skeleton mt-2 !rounded-xl"></div></div>`;
            } else { // hashtag
                 div.className = 'flex items-center p-4 border-b border-black/10';
                 div.innerHTML = `<div class="w-8 h-8 rounded-full skeleton mr-4"></div><div class="w-1/3 h-5 skeleton"></div>`;
            }
            return div;
        }

        // --- All rendering functions ---

        function renderUserResults(profiles, container) {
            if (!profiles || profiles.length === 0) {
                container.innerHTML += '<p class="p-4 text-center text-gray-500">Tidak ada pengguna yang cocok.</p>';
                return;
            }
            profiles.forEach((profile, index) => {
                const userInitial = profile.full_name ? profile.full_name.charAt(0).toUpperCase() : '?';
                const profilePicUrl = profile.profile_avatar_url || `https://placehold.co/48x48/1A1A1A/FFFFFF?text=${userInitial}&font=inter`;

                const profileElement = document.createElement('a');
                profileElement.href = `profile.html?user_id=${profile.id}`;
                profileElement.className = 'flex items-center p-4 border-b border-black/10 hover:bg-gray-50 transition-colors result-enter-animation';
                profileElement.style.animationDelay = `${index * 70}ms`;
                
                profileElement.innerHTML = `
                    <img src="${profilePicUrl}" alt="Profile Picture" class="w-12 h-12 rounded-full bg-gray-200 mr-4">
                    <div>
                        <p class="font-bold flex items-center">${profile.full_name} ${profile.is_verified ? '<span class="ml-1 text-blue-500"><i class="bi bi-patch-check-fill"></i></span>' : ''}</p>
                        <p class="text-sm text-gray-500">@${profile.username}</p>
                    </div>
                `;
                container.appendChild(profileElement);
            });
        }
        
        function renderPostResults(posts, container) {
            if (!posts || posts.length === 0) {
                 container.innerHTML += '<p class="p-4 text-center text-gray-500">Tidak ada postingan yang cocok.</p>';
                return;
            }
            posts.forEach((post, index) => {
                // IMPORTANT: createPostElement function needs to be available here
                const postElement = createPostElement(post); 
                postElement.style.animationDelay = `${index * 100}ms`;
                container.appendChild(postElement);
            });
        }
        
        function renderHashtagResults(hashtags, container) {
             if (!hashtags || hashtags.length === 0) {
                container.innerHTML += '<p class="p-4 text-center text-gray-500">Tidak ada hashtag yang cocok.</p>';
                return;
            }
            hashtags.forEach((tag, index) => {
                const tagElement = document.createElement('a');
                tagElement.href = `index.html?hashtag=${tag.hashtag}`;
                tagElement.className = 'flex items-center p-4 border-b border-black/10 hover:bg-gray-50 transition-colors result-enter-animation';
                tagElement.style.animationDelay = `${index * 70}ms`;
                tagElement.innerHTML = `
                    <div class="w-12 h-12 rounded-full bg-gray-100 mr-4 flex items-center justify-center">
                        <i class="bi bi-hash text-2xl text-gray-500"></i>
                    </div>
                    <div>
                        <p class="font-bold">#${tag.hashtag}</p>
                        <p class="text-sm text-gray-500">${tag.post_count} postingan</p>
                    </div>
                `;
                container.appendChild(tagElement);
            });
        }

        // --- All search functions ---

        async function searchUsers(query) {
             const { data, error } = await db.from('profiles').select('*').or(`full_name.ilike.%${query}%,username.ilike.%${query}%`).neq('id', currentUser.id).limit(20);
             if (error) { console.error('Error searching users:', error); return []; }
             return data;
        }

        async function searchPosts(query) {
             const { data, error } = await db.from('posts').select(`*, profiles(*), likes(user_id), reactions(*), comments(count), poll_votes(user_id, option_text)`).ilike('content', `%${query}%`).order('created_at', { ascending: false }).limit(20);
             if (error) { console.error('Error searching posts:', error); return []; }
             return data;
        }

        async function searchHashtags(query) {
             const { data, error } = await db.rpc('search_hashtags', { search_term: query });
             if (error) { console.error('Error searching hashtags:', error); return []; }
             return data;
        }

        async function handleSearch() {
            const query = searchInput.value.trim();
            if (query.length < 1) {
                searchResultsContainer.innerHTML = '<p class="p-4 text-center text-gray-500">Cari teman, postingan, atau tagar di Marhayu.</p>';
                return;
            }
            
            searchResultsContainer.innerHTML = ''; // Clear previous results
            for(let i=0; i<3; i++) { searchResultsContainer.appendChild(createSkeletonResult(activeSearchTab)); }

            if (activeSearchTab === 'all') {
                const [users, posts, hashtags] = await Promise.all([searchUsers(query), searchPosts(query), searchHashtags(query.replace('#', ''))]);
                searchResultsContainer.innerHTML = '';
                if(users.length === 0 && posts.length === 0 && hashtags.length === 0) {
                     searchResultsContainer.innerHTML = '<p class="p-4 text-center text-gray-500">Tidak ada hasil ditemukan.</p>';
                } else {
                    renderUserResults(users, searchResultsContainer);
                    renderPostResults(posts, searchResultsContainer);
                    renderHashtagResults(hashtags, searchResultsContainer);
                }
            } else if (activeSearchTab === 'users') {
                const users = await searchUsers(query);
                searchResultsContainer.innerHTML = '';
                renderUserResults(users, searchResultsContainer);
            } else if (activeSearchTab === 'posts') {
                const posts = await searchPosts(query);
                searchResultsContainer.innerHTML = '';
                renderPostResults(posts, searchResultsContainer);
            } else if (activeSearchTab === 'hashtags') {
                const hashtags = await searchHashtags(query.replace('#',''));
                searchResultsContainer.innerHTML = '';
                renderHashtagResults(hashtags, searchResultsContainer);
            }
        }
        
        // --- Tab UI and Logic ---

        function updateTabUI() {
            const indicator = document.getElementById('tab-indicator');
            const activeBtn = tabContainer.querySelector(`[data-tab="${activeSearchTab}"]`);
            if (!indicator || !activeBtn) return;
            
            tabContainer.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.add('text-gray-500');
                btn.classList.remove('text-black');
            });
            activeBtn.classList.add('text-black');
            activeBtn.classList.remove('text-gray-500');
            
            indicator.style.left = `${activeBtn.offsetLeft}px`;
            indicator.style.width = `${activeBtn.offsetWidth}px`;
        }

        tabContainer.addEventListener('click', (e) => {
            const tabButton = e.target.closest('.tab-btn');
            if (tabButton) {
                activeSearchTab = tabButton.dataset.tab;
                updateTabUI();
                handleSearch(); // Re-run search for the new tab
            }
        });

        // --- Debounce search input ---
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(handleSearch, 300);
        });
        
        // --- Logout and App Init ---
        document.getElementById('logout-button').addEventListener('click', async () => { 
            if(db) { await db.auth.signOut(); }
            window.location.href = 'auth.html'; 
        });

        async function initializeApp() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Network response was not ok');
                const config = await response.json();
                if (!config.supabaseUrl || !config.supabaseAnonKey) throw new Error('Supabase config is missing');
                db = createClient(config.supabaseUrl, config.supabaseAnonKey);
                initialize();
            } catch (error) {
                console.error("Initialization Error:", error);
                document.body.innerHTML = `<div class="text-center p-12"><h1 class="font-bold text-xl">Koneksi Gagal</h1><p class="text-gray-600">Tidak dapat terhubung ke server. Silakan coba lagi nanti.</p></div>`;
            }
        }
        
        // ==========================================================================================
        // == All functions for post rendering and interactivity (Copied from profile/index.html) ==
        // ==========================================================================================
        
        function createPostElement(post) { 
             const div = document.createElement('div');
            div.className = 'p-4 border-b border-gray-200 flex space-x-4 post-enter-animation';
            div.id = `post-${post.id}`;
            const profile = post.profiles;
            if (!profile) return div;
            const userHasLiked = (post.likes || []).some(like => like.user_id === currentUser.id);
            const likeCount = (post.likes || []).length;
            const commentCount = post.comments && post.comments[0] ? post.comments[0].count : 0;
            const userInitial = profile.full_name ? profile.full_name.charAt(0).toUpperCase() : '?';
            const profilePicUrl = profile.profile_avatar_url || `https://placehold.co/48x48/1A1A1A/FFFFFF?text=${userInitial}&font=inter`;
            
            const processedContent = post.content.replace(/@(\w+)|#(\w+)/g, (match, mention, hashtag) => {
                if (mention) return `<a href="profile.html?username=${mention}" class="text-blue-500 hover:underline">@${mention}</a>`;
                if (hashtag) return `<a href="index.html?hashtag=${hashtag.toLowerCase()}" class="text-blue-500 hover:underline">#${hashtag}</a>`;
            });

            let postContentHtml = '';
            if (post.is_full_text) {
                postContentHtml = `<div class="my-2 p-8 rounded-2xl flex items-center justify-center text-center text-white ${post.bg_color} min-h-[12rem]"><p class="text-2xl ${post.font_family}">${processedContent}</p></div>`;
            } else {
                let mediaHtml = '';
                if (post.image_url) mediaHtml = `<img src="${post.image_url}" loading="lazy" class="mt-2 rounded-2xl border border-black/10 w-full object-cover">`;
                else if (post.video_url) mediaHtml = `<div class="mt-2 custom-video-player" data-post-id="${post.id}"><video src="${post.video_url}" preload="metadata" class="w-full h-full" loop muted playsinline onerror="this.closest('.custom-video-player').innerHTML = '<div class=\\'text-center p-8 bg-gray-100 rounded-2xl text-gray-500 flex items-center justify-center min-h-[200px]\\'>Gagal memuat video.</div>'"></video><div class="video-controls-overlay"><button class="play-pause-btn interactive-btn"><i class="bi bi-play-fill text-3xl"></i></button><button class="volume-btn"><i class="bi bi-volume-mute-fill"></i></button></div><div class="video-progress-bar"><div class="video-progress-filled"></div></div></div>`;
                postContentHtml = `<p class="my-2 whitespace-pre-wrap">${processedContent}</p>${mediaHtml}`;
            }

            if (post.is_promotion && post.promotion_link) {
                postContentHtml += `<div class="mt-3"><a href="${post.promotion_link}" target="_blank" rel="noopener noreferrer" class="w-full block bg-blue-500 text-white text-center py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">${post.promotion_button_text || 'Learn More'}</a></div>`;
            }

            const sponsoredLabel = post.is_promotion ? `<p class="text-xs text-gray-500 font-semibold mt-1">Sponsored by ${profile.full_name}</p>` : '';
            
            div.innerHTML = `
                <div><a href="profile.html?user_id=${profile.id}"><img src="${profilePicUrl}" alt="Profile Picture" class="w-12 h-12 rounded-full bg-gray-200" loading="lazy"></a></div>
                <div class="w-full">
                    <div class="flex justify-between items-start">
                        <div>
                            <a href="profile.html?user_id=${profile.id}" class="hover:underline">
                                <p class="font-bold flex items-center">${profile.full_name} ${profile.is_verified ? '<span class="ml-1 text-blue-500"><i class="bi bi-patch-check-fill"></i></span>' : ''}
                                <span class="ml-2 text-sm text-gray-500 font-normal">@${profile.username}</span></p>
                            </a>
                            <p class="text-xs text-gray-500">${new Date(post.created_at).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' })}</p>
                        </div>
                         ${post.user_id === currentUser.id ? `<button data-post-id="${post.id}" class="delete-post-button text-gray-400 hover:text-red-500 text-xl">&times;</button>` : ''}
                    </div>
                    ${postContentHtml}
                    ${sponsoredLabel}
                    <div class="flex items-center justify-around text-gray-500 mt-3">
                        <button data-post-id="${post.id}" class="comment-button flex items-center space-x-1 hover:text-blue-500 interactive-btn"><i class="bi bi-chat text-xl"></i><span class="comment-count">${commentCount}</span></button>
                        <button data-post-id="${post.id}" data-liked="${userHasLiked}" class="like-button flex items-center space-x-1 ${userHasLiked ? 'text-red-500' : 'hover:text-red-500'} interactive-btn"><i class="bi ${userHasLiked ? 'bi-heart-fill' : 'bi-heart'} text-xl"></i><span class="like-count">${likeCount}</span></button>
                        <button data-post-id="${post.id}" class="copy-link-button hover:text-green-500 interactive-btn"><i class="bi bi-link-45deg text-xl"></i></button>
                    </div>
                </div>`;
            return div;
        }

        // Add event listeners for post interactions
        searchResultsContainer.addEventListener('click', async e => {
            const likeButton = e.target.closest('.like-button:not(.like-comment-button)');
            if (likeButton) {
                const postId = likeButton.dataset.postId;
                // Simplified like logic for brevity. A full implementation would be here.
                console.log(`Liking post ${postId}`);
                db.rpc('toggle_like', { user_id_to_toggle: currentUser.id, post_id_to_toggle: postId });
            }

            const commentButton = e.target.closest('.comment-button');
            if (commentButton) {
                // In a real app, you would need the full openCommentModal logic here
                alert(`Opening comments for post ${commentButton.dataset.postId}`);
            }
        });


        initializeApp();
    </script>
</body>
</html>
